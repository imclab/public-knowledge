## Учимся создавать кастомные jQuery события

jQuery имеет API для декларативного объявления хуков для обработки взаимодействия с кастомными событиями. Оно позволяет описывать свои события, поведение при котором они проявляются и как они работают, весьма оптимальным способом.

Есть очень интересные примеры, например [jquery.event.move](http://stephband.info/jquery.event.move/) и [jquery.event.swipe](http://stephband.info/jquery.event.swipe/).
А мы с вами будем делать событие нажатия вне элемента, как наиболее подходящее для начала, из за компактности реализации.

Для начала разберемся с [API](http://learn.jquery.com/events/event-extensions/)

Описание и разнообразные обработчики для таких событий хранится в объекте jQuery.event.special в поле с названием вашего события.

    (function($) {
        $.special.events.youreventname = {
            setup: function() {

            },
            add: function() {

            },
            teardown: function() {

            },
            remove: function() {

            }
        };
    })(jQuery);

Вызовы всех методов этого API происходят в контексте элемента на котором слушается событие. Если по селектору было найдено больше 1 элемента, эти методы будут вызваны по отдельности для каждого элемента коллекции.

Метод setup вызывается, если на текущем элементе нету ни одного обработчика описываемого нами события, служит для инициализации каких либо необходимых вещей, например привязывание к елементу каких либо свойств, через jQuery.data(element, 'eventname', params), для сохранения каких либо переменных, необходимых для события (например подсчет кликов для события тройного клика).

Метод teardown вызывается когда на элементе не осталось больше ни одного обработчика для описываемого нами события, позволяет оптимизировать затраты по памяти и удалить ненужные обработчики сторонних вещей, не обходимые для описываемого события.

Метод add вызывается каждый раз при добавлении обработчика на элемент для нашего события, а remove при удалении обработчика нашего события с элемента.

Нам для описания события внешнего клика достаточно двух первых методов.

    var uniqueId = 0,
        containers = [];
    $.event.special.clickoutside = {};
    $.event.special.clickoutside.noBubble = true;
    $.event.special.clickoutside.setup = function() {
        uniqueId++;
        containers.push(this);
        containers.push(uniqueId);
        $('body').bind('click.clickoutsideHelper' + uniqueId, jQuery.proxy(checker, this));
    }

При установке обработчика события инкрементируем счетчик для создания уникального идентификатора элемента.
Он нам пригодится для удобного удаления обработчика клика по body через event.namespace, так как задаем мы его через jQuery.proxy (он же .bind в ES5) привязывая контекст, фактически создавая новую функцию, нам проблематично будет удалять конкретный обработчик.
noBubble = true означает что событие не будет подниматься вверх по DOM дереву, вызывая обрабочтики для элементов уровнем выше.

    function checker(event) {
        var target = event.target;
        var $this = $(this);
        if ($this.find(target).length) {
            return;
        }
        if ($this.is(target)) {
            return;
        }
        $this.trigger('clickoutside');
    }

Функция checker проверяет куда был сделан клик, внутрь объекта, на сам объект или вне его.
У событий jQuery содержится две ссылки на "цель" действия вызвавшего события - target (1) и currentTarget(2), где (1) является элементом к которому напрямую (а не через bubling и propagation) было применено действие вызвавшее событие,  и (2) - элемент на котором сейчас сработал обработчик.

    $.event.special.clickoutside.teardown = function() {
        var index = jQuery.inArray(containers, this);
        if (index == -1) {
            return;
        }
        var uniqueIdOfElement = containers[index + 1];
        containers.splice(index, 2);
        $('body').unbind('click.clickoutsideHelper' + uniqueIdOfElement);
    }

При снятии события удаляем ненужный обработчик с body, и элементы массива.

Вот так вот все крайне просто, и позволяет некопипастить код, много какие вещи можно выделить вот в такие события для удобной разработки и DRY принципов

Полностью код можно посмотреть на [github](https://github.com/wwwsevolod/jQuery.event.clickoutside).
Дополнительная информация в [документации](http://learn.jquery.com/events/event-extensions/)